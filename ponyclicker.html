<!doctype html>
<html>
<head>
  <title>Pony Clicker</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta charset="utf-8" />
  <meta name="description" content="Pony Clicker v0.1 by Cloud Hop" />
  <meta name="copyright" content="Copyright (c)2015 Cloud Hop" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="./ponyclicker.css" media="screen"/>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:700,400' rel='stylesheet' type='text/css'></link>
</head>
<body onresize="ResizeCanvas();" onload="doOnLoad();">
  <div class="container">
    <div id="ponyboard">
      <canvas id="canvas" width="100" height="100"></canvas>
      <div id="ponybg" class="bg">
      <img id="img_rays" style="display:none;" src="rays.svg" alt=""/>
      <img id="img_ground" style="display:none;" src="ground.svg" alt=""/>
      </div>
      <div class="ponies">
        <canvas id="canvaslines" width="520" height="520" style="position:relative;background:transparent;left:-260px;top:-260px;"></canvas>
        <div id="ponywrapper"></div>
      </div>
      <div id="score"><span id="scorenum">0 Smiles</span><div id="SPS">+0.1 per second</div></div>
      <div class="newsactive"><p><span id="news0" class="inactive">News: stuff</span></p><p><span id="news1" class="inactive">News: other stuff</span></p></div>
    </div>
  </div>
  <div class="button" id="menubutton" onclick="ShowMenu(true);">Menu &raquo;</div>
  <div id="menu" class="menu">
  <div class="button" onclick="ShowMenu(false);">Menu &laquo;</div>
  <div class="button" onclick="EarnAchievement(200); SaveGame()">Save</div>
  <div class="button" onclick="EarnAchievement(201); document.getElementById('exportarea').innerHTML = ExportGame(); document.getElementById('exportwindow').style.display='inline-block';">Export</div>
  <div class="button" onclick="document.getElementById('credits').style.display='inline-block';">Credits</div>
    <hr/>
    <input type="checkbox" id="EnableEffects" onchange="GetSettings()" />
    <label for="EnableEffects" >Enable canvas effects</label>
    <br/><input type="checkbox" id="EnableFocus" onchange="GetSettings()" />
    <label for="EnableFocus" >Lower FPS when not focused</label>
    <br/><input type="checkbox" id="EnableWarn" onchange="GetSettings()" />
    <label for="EnableWarn" >Warn when closing window</label>
      <hr/>
      Smiles Available: <span id="stat_cursmiles">0</span>
      <br/>Total Smiles: <span id="stat_totalsmiles">0</span>
      <br/>Smiles Per Second: <span id="stat_SPS">0</span>
      <br/>Pony Clicks: <span id="stat_clicks">0</span>
      <br/>Smiles Per Click: <span id="stat_SPC">0</span>
      <br/>Buildings Owned: <span id="stat_buildings">0</span>
      <br/>Time Played: <span id="stat_time">0</span>
      <br/>Muffins: <span id="stat_muffins">0</span> <span class="fade">(<span id="stat_achievementmuffins">0</span> from achievements)</span>
      <hr/>
      <div class="button" onclick="var x = window.prompt('Paste your exported game data here to import it. WARNING: This will overwrite your current game, even if the data is corrupt! Be sure you export your current game if you don\'t want to lose anything!',''); if(x!==null) { ImportGame(x); }">Import</div>
      <div class="button" onclick="if(window.confirm('This will destroy all your cookies, buildings, and upgrades, but you\'ll keep you\'re achievements and your muffins. Are you sure you want to do this?')) { ResetGame(); }" style="color:#c00">Reset</div>
      <div class="button" onclick="if(window.confirm('This will irreversibly wipe ALL your data, including all settings and all achievements! Are you certain you want to do this?')) { WipeAllData(); }" style="color:#c00">Wipe All Data</div>
      <hr/>
      Upgrades Owned: <span id="upgrades_owned"></span>/<span id="upgrades_total"></span>
      <div id="upgradelist"></div>
      <hr/>
      Achievements: <span id="achievements_owned"></span>/<span id="achievements_total"></span>
      <div id="achievements"></div>
      <hr/>
      <span style="display:block;font-size:70%;height:40px;"><a href="https://www.youtube.com/watch?v=otAFRGL4yX4" onclick="EarnAchievement(204);">The smile song is mandatory while playing this.</a></span>
    <div id="menuoverlay" class="tooltip">TEST</div>
  </div>
  <div class="store" id="storewrapper">
    <div class="title">Sugarcube Corner</div>
    <div class="upgrades" id="storeupgrades"></div>
    <ol id="store"></ol>
  </div>
  
  <div id="overlay" class="tooltip" data-item="2"></div>
  <div id="exportwindow" class="modal" style="width: 350px;display:none;margin-top:-150px;">
    <b>Export Save</b>
    <hr/>
    Copy and paste this somewhere safe. To restore your game, click the import button and paste this into the dialog box.
    <br/>
    <br/><textarea id="exportarea" style="width:345px;height:150px;" readonly></textarea>
    <hr/>
    <div class="button" style="position:relative;left:50%;margin-left:-26px;" onclick="document.getElementById('exportwindow').style.display='none';">Done!</div>
    
  </div>
  <div id="credits" class="modal" style="width: 450px;display:none;margin-top:-200px;">
    <div class="button" style="position:absolute; right:0; top:0" onclick="document.getElementById('credits').style.display='none';">[x]</div>
    <b>Pony Clicker v0.5 <i>by</i> Cloud Hop</b>
    <hr/>
    <div><a href="http://www.fimfiction.net/user/Cloud%20Hop"><img style="float:left;" src="./Cloudhop_goggles.png" alt="Cloud Hop Avatar" title="If you aren't careful, he might cute you to death." onclick="EarnAchievement(203);"/></a> Cloud Hop is a pegasus who works at the weather factory. He's also an <a href="http://blackhole12.blogspot.com/">applied mathematician</a> who makes <a href="https://github.com/blackhole12">games</a> and <a href="https://erikmcclure.bandcamp.com/album/aurora-theory">music</a>. Sometimes he puts them on the internet, corrupting it with the magic of friendship.
      <ul><li><a href="http://www.fimfiction.net/user/Cloud%20Hop">Fimfiction</a></li>
      <li><a href="http://blackhole12.newgrounds.com">Newgrounds</a></li>
      <li><a href="https://soundcloud.com/blackhole12">Soundcloud</a></li>
      <li><a href="http://blackhole12.blogspot.com/">Blogger</a></li>
      <li><a href="https://www.youtube.com/channel/UCWC8FC5JryUP7I1oN1twBeQ">Youtube</a></li>
      <li><a href="https://twitter.com/blackhole0173">Twitter</a></li>
      </ul>
      </div>
      <p>
        Pony vectors by: <a href="http://blackhole12.deviantart.com/art/Pinkie-Pie-PARTY-TIME-274526114">Takua770</a>, <a href="http://destroyer735.deviantart.com/art/Octavia-375057218">destroyer735</a>, <a href="http://90sigma.deviantart.com/art/Vector-All-the-Ponies-SVG-Files-302442314">90sigma</a>, <a href="http://www.deviantart.com/art/Rainbow-Dash-244004139">Nethear</a>, <a href="http://www.deviantart.com/art/Applebloom-490330115">LMan225</a>, <a href="http://www.deviantart.com/art/MLP-Resource-Dinky-Hooves-01-212564935">ZuTheSkunk</a>,<a href="http://90sigma.deviantart.com/art/Snooty-Princess-Cadance-321870154">90sigma (again)</a>, <a href="http://racefox.deviantart.com/art/Rarity-405280335">racefox</a>, <a href="http://qazwsx302.deviantart.com/art/Sweetie-Belle-316776921">qazwsx302</a>, <a href="http://sakatagintoki117.deviantart.com/art/Shining-Armor-339746794">sakatagintoki117</a>
        <br/>Pinkie Pie face taken from Fimfiction emoticons.
        <br/><strong>Playtesters:</strong> Fyrestorm, Karzafal, #fimfiction IRC
      </p>
      <hr/>
      <div class="footer"><a href="https://github.com/blackhole12/PonyClicker">Fork this project on Github</a></div>
  </div>
  <div id="mousetexts"></div>
  <div id="notices"></div>
  <script type="text/javascript">
  function CreateGame() {
    return { 
      upgrades:[], // list of upgrade IDs that are owned
      smiles:0,
      totalsmiles:0,
      SPC:1,
      SPS:0,
      shiftDown:false,
      totalTime:0,
      clicks:0,
      achievements:{}, // List of achievements as an object that we pretend is a hash.
      achievementcount:0, // We can't efficiently count properties so we store a length ourselves.
      muffins:0, // total muffin count, which is a combination of muffins gained from achievements and prestige.
      achievement_muffins:0, // Muffins from achievements only, recalculated every time an achievement is earned
      store:[1,0,0,0,0,0,0,0,0,0,0,0,0], // amount player has bought of each store item.
      ponyList:genPonyList(), // precalculated list of randomized ponies (so we can reconstruct them after a save/load)
      version:2, // incremented every time this object format changes so we know to deal with it.
      settings: {
        useCanvas:true,
        optimizeFocus:false,
        closingWarn:false,
      }
    };
  }
  
  var PonyList = ["pinkie.svg", "Adagio Dazzle.svg", "Aloe.svg", "Amethyst Star.svg", "Applebloom.svg", "Applejack.svg", "Aria Blaze.svg", "Babs Seed.svg", "Berry Punch.svg", "Big Macintosh.svg", "Braeburn.svg", "Carrot Top.svg", "Cheerilee.svg", "Cheese Sandwich.svg", "Chrysalis.svg", "Cloudchaser.svg", "Coco Pommel.svg", "Colgate.svg", "Daring Do.svg", "Diamond Tiara.svg", "Dinky Doo.svg", "Ditsy Doo.svg", "Dr Whooves.svg", "Fancy Pants.svg", "Flam.svg", "Fleur de Lis.svg", "Flim.svg", "Flitter.svg", "Fluttershy.svg", "Hoity Toity.svg", "King Sombra.svg", "Lightning Dust.svg", "Lotus.svg", "Lyra Heartstrings.svg", "Maud Pie.svg", "Mrs Harshwhinny.svg", "octavia.svg", "Prince Blueblood.svg", "Princess Cadance.svg", "Princess Celestia.svg", "Princess Luna.svg", "Rainbow Dash.svg", "Rarity.svg", "Scootaloo.svg", "Shining Armor.svg", "Silver Spoon.svg", "Sonata Dusk.svg", "Starlight Glimmer.svg", "Sunset Shimmer.svg", "Sweetie Belle.svg", "Thunderlane.svg", "Trenderhoof.svg", "Trixie.svg", "Trouble Shoes.svg", "Twilight Sparkle.svg", "Zecora.svg" ];
  function shuffle(o){
      for(var j, x, i = o.length; i; j = GetRandNum(0, i), x = o[--i], o[i] = o[j], o[j] = x);
      return o;
  };
  function genPonyList() {
    var list = [];
    for(var i = 1; i < PonyList.length; ++i) {
      list.push(i);
    }
    shuffle(list);
    list.unshift(0);
    return list;
  }
  
  var Game = CreateGame();
  var curMouseX=0;
  var curMouseY=0;
  
  function UpdateMuffins() {
    stat_muffins.innerHTML = PrettyNum(Game.muffins);
    stat_achievementmuffins.innerHTML = PrettyNum(Game.achievement_muffins);
  }
  function ResetGame() {
    var muffins = Math.floor(inv_triangular(Game.totalsmiles/1000000000))-1;
    Game.muffins += muffins;
    ShowNotice("Game reset", ((muffins==0)?null:"You get <b>" + Pluralize(muffins, " muffin") + "</b> for your <b>" + Pluralize(Game.totalsmiles, " smile") + "</b>"), null);
    Game.store = [1,0,0,0,0,0,0,0,0,0,0,0,0];
    Game.upgrades = [];
    Game.smiles = 0;
    Game.totalsmiles = 0;
    Game.SPC = 1;
    Game.SPS = 0;
    Game.clicks = 0;
    SaveGame();
    InitializeGame(); 
  }
  function WipeAllData() { localStorage.removeItem('game'); Game = CreateGame(); InitializeGame(); }
  function ParseGame(src) {
    var g = JSON.parse(src);
    switch(g.version)
    {
      case 2:
        Game = g;
        break;
      default:
        alert('Unrecognized version! Game not loaded.');
    }
  }
  function ImportGame(src) { 
    ParseGame(src);
    InitializeGame();
    EarnAchievement(202);
  }
  function InitializeGame() {
    UpdateOverlay(-1,0);
    Earn(0);
    UpdateSPS();
    OrganizePonies();
    ApplySettings();
    UpdateNews();
    UpdateMuffins();
    updateUpgradesAchievements();
  }
  function LoadGame() { 
    if(localStorage.getItem('game')!==null) { ParseGame(localStorage.getItem('game')); } 
    ApplySettings(); 
  }
  
  function ExportGame() { return JSON.stringify(Game); }
  function SaveGame() { localStorage.setItem('game', ExportGame()); ShowNotice("Game saved", null, null); }
  function ApplySettings() {
    document.getElementById('EnableEffects').checked = Game.settings.useCanvas;
    document.getElementById('EnableFocus').checked = Game.settings.optimizeFocus;
    document.getElementById('EnableWarn').checked = Game.settings.closingWarn;
  }
  function GetSettings() {
    Game.settings.useCanvas = document.getElementById('EnableEffects').checked;
    Game.settings.optimizeFocus = document.getElementById('EnableFocus').checked;
    Game.settings.closingWarn = document.getElementById('EnableWarn').checked;
  }
  
  LoadGame();
  
  var Store = [
    {cost:0,count:1,pbonus:0,mbonus:1,name:"Pony", plural: "ponies", desc: "This is a pony. Ponies need friendships to generate smiles."}, 
    {cost:0,count:0,pbonus:0,mbonus:1,name:"Friend", plural: "friends", desc: "A friendship between two ponies. You can't buy a friendship if everypony is friends with everypony else!", formula: "Each friendship generates 0.5 smiles per second"}, 
    {cost:0,count:0,pbonus:0,mbonus:1,name:"Recital", plural: "recitals", desc: "A small recital for everypony you know.", formula: "Generates one smile per pony.<i>SPS = P</i>"}, // P
    {cost:0,count:0,pbonus:0,mbonus:1,name:"Party", plural: "parties", desc: "Throw a party for all your friends!", formula: "Generates one smile per friendship.<i>SPS = F</i>"}, // F
    {cost:0,count:0,pbonus:0,mbonus:1,name:"Parade", plural: "parades", desc: "Throw a big parade for everypony and all their friends!"}, // P+F
    {cost:0,count:0,pbonus:0,mbonus:1,name:"Concert", plural: "concerts", desc: "Throw a concert for the whole town!"}, // P+F+B
    {cost:0,count:0,pbonus:0,mbonus:1,name:"Festival", plural: "festivals", desc: "Celebrate a festival for a whole weekend!"}, // P*F
    {cost:0,count:0,pbonus:0,mbonus:1,name:"Rave", plural: "raves", desc: "Throw a gigantic rave party in Canterlot!"}, // P*(F+B)
    {cost:0,count:0,pbonus:0,mbonus:1,name:"Grand Galloping Gala", plural: "grand galloping galas", desc: "Celebrate the Grand Galloping Gala with ponies from all over Equestria!"}, //P*F*B
    {cost:0,count:0,pbonus:0,mbonus:1,name:"Coronation", plural: "coronations", desc: "Make some random pony a princess so you have an excuse to party all night!"}, //2^P
    {cost:0,count:0,pbonus:0,mbonus:1,name:"National Holiday", plural: "national holidays", desc: "Declare a national holiday so everypony in equestria can party with you instead of doing anything useful!"}, //2^P*F
    {cost:0,count:0,pbonus:0,mbonus:1,name:"Elements Of Harmony", plural: "Elements of Harmony", desc: "Use a giant rainbow friendship beam to solve all your problems!"}, //2^P*(F+B)
    {cost:0,count:1,name:"DEBUGMOUSE", plural:"DEBUGMOUSES", desc: "DEBUG DO NOT USE"}
  ];
  
  function factorial(n) { var r = n; while(--n > 1) { r = r*n; } return r; }
  function max_binomial(n) { var n2=Math.floor(n/2); var r = n; while(--n > n2) { r = r*n; } return Math.floor(r/factorial(n2)); }
  
  var number_names = [
  "million",
  "billion",
  "trillion",
  "quadrillion",
  "quintillion",
  "sextillion",
  "septillion",
  "octillion",
  "nonillion",
  "decillion",
  "undecillion",
  "duodecillion",
  "tredecillion",
  "quattuordecillion", // This name is so long it breaks formatting in places :C
  "quindecillion",
  "sexdecillion",
  "septendecillion",
  "octodecillion",
  "novendecillion",
  "vigintillion",
  "centillion"];
  
  function GetRandNum(min, max) { // Random number in the range [low, high) 
    return Math.floor(Math.random()*(max-min))+min;
  }
  
  function GetNews() {
    var news = [];
    
    // These are specific smile count related messages
    if(Game.totalsmiles < 30) {
      news.push(
        "Ponyville down in the dumps, reports anonymous bystander.",
        "Ponyville reports distinct lack of smiles.",
        "Smile forecast for today: Depression with a touch of despair.",
        "Ponyville in desperate need of excitement.",
        "Antidepressants selling out all across Ponyville.",
        "Mayor Mare asked why everyone is feeling so down, reports she can't be bothered to figure it out."
      );
    } else if(Game.totalsmiles < 1000) {
      news.push("Ponyville citizens wonder what this strange new sensation is! Scientists call it 'smiling', conspiracy theorists denounce it as a ploy to take over the world.",
        "Morose ponies increasingly out of place in chipper Ponyville!",
        "Small foals spotted playing in the streets! Parents unsure if so called 'fun' should be allowed.");
    } else if(Game.totalsmiles < 1000000) {
      news.push("Ponies greeting each other with a smile! Cranky old ponies decry new development!");
    } else if(Game.totalsmiles < 1000000000) {
      news.push("Songs now spontaneously erupting across Ponyville!");
    } else if(Game.totalsmiles < 1000000000000) {
      news.push(
        "Princess Twilight found overdosed on friendship, taken to rehab center!",
        "Citizens of Ponyville so happy they invent new word for it! Debates about how to spell it immediately turn into murderous riots!");
    } else if(Game.totalsmiles < 1000000000000000) {
      news.push("Ponyville citizens suffer from chronic happiness! Doctors unsure if it's actually a problem or not!");
    } else if(Game.totalsmiles < 1000000000000000000) {
      news.push("Scientists split friendship and discover a runaway chain reaction! Nuclear friendship bomb proposed by military!");
    } else {
      news.push("New system of physics suggests all matter in universe composed of different kinds of smiles!");
    }
    
    // After 10000 smiles we start putting in most of the standard news messages into rotation.
    if(Game.totalsmiles > 10000) {
      news.push(
        'Twilight found shipping Rainbow Dash with everything in the universe! Riots erupt all across Equestria!',
        'Lyra and BonBon revealed as "just friends"! Ponies everywhere faint in shock!',
        "Celestia's insatiable desire for cake causes caketastrophe in the Royal Kitchen! A memorial service for the lost chocolate chips to be held on Monday.",
        "Pink menace at Sugarcube corner goes batty, takes 15 muffins hostage!",
        "Citizens of Ponyville vote to create a public library instead of relying on a private collection organized by a crazed purple mare!",
        "Small colt finds lost Apple barn floating in space. Rainbow Dash claims she has no idea how it got up there.",
        "Rarity joins environmentalists, declares she will no longer go to the spa. Ponyville's spa immediately goes bankrupt.",
        "Following an incident involving mislabeled sodium and an exploding toilet, Celestia orders Sweetie Bot to register herself as a lethal weapon.",
        "Rainbow Dash reportedly investing in the Cloud. Pegasi everywhere confused by what this means.",
        "Princess Twilight discovers that ponies are actually tiny nuclear reactors! \"That explains why I never need to go to the bathroom,\" says Rainbow Dash.",
        "Pony pony Pony pony pony pony Pony pony!",
        "Princess Twilight Sparkle dating a peach! The peach has no comment on the matter."
      );
      
      if(Game.muffins > 10) {
        news.push(
          'When asked how she saved the bakery from certain disaster, Derpy Hooves claims there was "Muffin to it!"',
          "Try new smile-powered Muffins today!",
          'Mayor held hostage by crazed Doctor, who demanded that a muffin factory be built "for the sake of all ponykind!"'
        );
      }
      if(Game.muffins > 100) {
        
      }
    }
    
    return news[GetRandNum(0, news.length)];
  }
  var newsnum = 0;
  var newswait = 15000;
  var lastNews;
  function UpdateNews() {
    var n1 = newsnum;
    newsnum = (newsnum + 1) % 2;
    var n2 = newsnum;
    document.getElementById('news' + n1).className = '';
    document.getElementById('news' + n2).className = 'inactive';
    document.getElementById('news' + n1).innerHTML = "News: " + GetNews();
  }
  function PrettyNum(x) {
    var d = Math.floor(Math.log10(x));
    if(d<6) return x.toFixed(0);
    x = Math.floor(x/Math.pow(10,d-(d%3)-3));
    var n = Math.floor((d-3)/3) - 1;
    if(n >= number_names.length) return "Infinity";
    return (x/1000) + " " + number_names[n];
  }
  function Pluralize(n, s) { return PrettyNum(n) + s + ((n==1)?'':'s'); }
  
  function basic_upgrade(item, p, m) { Store[item].mbonus *= (1.0+m); Store[item].pbonus *= (1.0+m); Store[item].pbonus += p; }
  function global_upgrade(p, m) { for(var i = 0; i < Store.length; ++i) basic_upgrade(i, p, m); }
  function gen_upgradetype1(item, pSPS, mSPS) { return function() { var c = Game.store[item]; basic_upgrade(item, pSPS*c, mSPS*c); } }
  function gen_upgradetype2(item, pSPS, mSPS) { return function() { Game.SPC+=(pSPS*Game.store[item]); Game.SPC*=(1+mSPS); } }
  function gen_muffinupgrade(pSPS, mSPS) { return function() {  global_upgrade(pSPS, mSPS*Game.muffins); } }
  
  var upgradeList = [ {cost:0, name:"UNDEFINED", desc:"ERROR", fn:null},
    {cost:400, name:"Clicking Assistants", desc: "Clicking gets +1 SPS for every pony you have.", fn:function(){gen_upgradetype2(Game.store[0], 0)();} },
    {cost:4000, name:"Friendship is Clicking", desc: "Clicking gets +1 SPS for every friendship you have.", fn:function(){gen_upgradetype2(Game.store[1], 0)();} },
    {cost:40000, name:"Ticklish Cursors", desc: "Clicking gets 1% of your SPS.", fn:gen_upgradetype2(1, 0) },
    {cost:400000, name:"Feathered Cursors", desc: "Clicking gets 2% of your SPS.", fn:gen_upgradetype2(1, 0) },
    {cost:4000000, name:"Advanced Tickle-fu", desc: "Clicking gets 3% of your SPS.", fn:gen_upgradetype2(1, 0) },
    {cost:40000000, name:"Happiness Injection", desc: "Clicking gets 4% of your SPS.", fn:gen_upgradetype2(1, 0) },
    
    {cost:10000, name:"Friendship Is Magic", desc: "Friendships generate +1 SPS for every other friendship.", fn:gen_upgradetype1(1, 1, 0) },
    {cost:1000000, name:"Friendship Is Spellcraft", desc: "Friendships generate +10 SPS for every other friendship.", fn:gen_upgradetype1(1, 10, 0) },
    {cost:100000000, name:"Friendship Is Sorcery", desc: "Friendships generate +100 SPS for every other friendship.", fn:gen_upgradetype1(1, 100, 0) },
    {cost:10000000000, name:"Friendship Is Witchcraft", desc: "Friendships generate +1000 SPS for every other friendship.", fn:gen_upgradetype1(1, 1000, 0) },
    {cost:1000000000000, name:"Friendship Is Benefits", desc: "Friendships generate +10000 SPS for every other friendship.", fn:gen_upgradetype1(1, 10000, 0) },
    {cost:50000, name:"Upgrade 3", desc: "Parties generate +1 SPS for every other party.", fn:gen_upgradetype1(2, 1, 0) },
    {cost:7777777, name:"I just don't know what went wrong!", desc: "You gain +1% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.01) },
    {cost:777777777, name:"That one mailmare", desc: "You gain +2% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.02) },
    {cost:77777777777, name:"Derpy Delivery Service", desc: "You gain +3% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.03) },
    {cost:7777777777777, name:"Blueberry Muffins", desc: "You gain +4% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.04) },
    {cost:777777777777777, name:"Chocolate-chip Muffins", desc: "You gain +5% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.05) },
    {cost:77777777777777777, name:"Lemon Muffins", desc: "You gain +6% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.06) },
    {cost:7777777777777777777, name:"Poppy seed Muffins", desc: "You gain +7% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.07) },
    {cost:777777777777777777777, name:"Muffin Bakeries", desc: "You gain +8% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.08) },
    {cost:77777777777777777777777, name:"Designer Muffins", desc: "You gain +9% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.09) },
    {cost:7777777777777777777777777, name:"Muffin Factories", desc: "You gain +10% SPS for every muffin you have.", fn:gen_muffinupgrade(0, 0.1) },
    {cost:0, name:"DEBUGMOUSE", desc: "DEBUG ONLY", fn:function(){Game.SPC*=2;}}
  ];
  
  for(var i = 0; i < upgradeList.length; ++i) {
    upgradeList[i].id = i;
  }
  document.getElementById('upgrades_total').innerHTML = (upgradeList.length-1).toFixed(0); //-1 for the error one at 0
  
  var achievementList = {
    '1': { name:"Participation Award", desc: "You moved the mouse!", muffins:0},
    '2': { name:"Hi there!", desc: "Click a pony <b>once</b>.", muffins:0, cond:function(){ return Game.clicks > 0; } }, 
    '200': { name:"Cautious", desc: "Manually save the game.", muffins:1},
    '201': { name:"Paranoid", desc: "Export a save.", muffins:1},
    '202': { name:"Time Machine", desc: "Import a save.", muffins:1},
    '203': { name:"Narcissism!", desc: "Click the image of Cloud Hop on the credits page.", muffins:1},
    '204': { name:"Music Makes Everything Better", desc: "Listen to the smile song.", muffins:1},
    '205': { name:"You Monster", desc: "Sell a friendship.", muffins:1},
    '255': { name:"Completionist", desc: "Get all the achievements.", muffins:100}
  };
  
  function genAchievements(names, amounts, descgen, condgen) {
    var ids = [];
    
    if(names.length != amounts.length) { alert("ERROR: names != amounts"); }
    for(var i = 0; i < names.length; ++i) {
      ids.push(achievementCount);
      achievementList[achievementCount++] = { name:names[i], desc: descgen(amounts[i]), muffins:(i+1), cond:condgen(amounts[i]) };
    }
    
    return ids;
  }
  
  var achievementCount = 3;
  var achievements_clicks = genAchievements(
    ["That tickles!", "Tickle War", "Tickle War II: The Retickling", "This Can't Be Healthy", "Carpal Tunnel Syndrome", "Wrist In Pieces", "Clickception"],
    [10,100,1000,10000,100000,1000000,10000000],
    function(n) { return "Click a pony <b>"+PrettyNum(n)+"</b> times."; },
    function(n) { return function() { return Game.clicks >= n; }; });
  achievements_clicks.push(2);
    
  var achievements_smiles = genAchievements(
    ["Laughter", "Joy", "Bliss", "Nirvana", "Ecstasy", "Pursuit of Happyness", "You Can Stop Now", "This Is Ridiculous", "Go Read A Book", "How?!"],
    [100,10000,1000000,100000000,10000000000,1000000000000,100000000000000,10000000000000000,1000000000000000000,100000000000000000000],
    function(n) { return "Get <b>"+PrettyNum(n)+"</b> smiles."; },
    function(n) { return function() { return Game.totalsmiles >= n; }; });
    
  function genShopCond(item) {
    return function(n) { return function() { return Game.store[item]>=n; }; };
  }
  
  var achievements_shop = [];
  function genShopAchievements(item, names) {
    return genAchievements(
    names,
    [1, 50, 100, 200, 300],
    function(n) { return "Buy <b>"+Pluralize(n, "</b> " + Store[item].name.toLowerCase()) + "."; },
    genShopCond(item));
  }
  
  achievements_shop = achievements_shop.concat(genShopAchievements(2, ["Hobbyist", "Street Musician", "Performer", "Multi-instrumentalist", "Conductor"]));
  achievements_shop = achievements_shop.concat(genShopAchievements(3, ["Extrovert", "Socialite", "Party Cannon", "Life Of The Party", "Pinkie Pie"]));
  achievements_shop = achievements_shop.concat(genShopAchievements(4, ["Float Attendee", "Giant Floating Rainbow Dash", "Way Too Much Confetti", "Mane Attraction", "Mayor Mare"]));
  achievements_shop = achievements_shop.concat(genShopAchievements(5, ["Piano Solo", "String Quartet", "Chamber Choir", "70 Piece Orchestra", "Octavia"]));
  achievements_shop = achievements_shop.concat(genShopAchievements(6, ["Summer Sun Celebration", "Running Of The Leaves", "Winter Wrap Up", "Hearth's Warming Eve", "Rite Of Spring"]));
  achievements_shop = achievements_shop.concat(genShopAchievements(7, ["Enthusiast", "Headbanger", "GLOWSTICKS FOR EVERYPONY!", "Bass Pumper", "DJ Pon3"]));
  achievements_shop = achievements_shop.concat(genShopAchievements(8, ["Best Night Ever", "Aristocracy", "Ballroom Dance", "YOU'RE GOING TO LOVE ME!", "Really Boring"]));
  achievements_shop = achievements_shop.concat(genShopAchievements(9, ["Princess Twilight", "Prince Shining Armor", "Princess Big Mac", "Princess Derpy", "EVERYPONY'S A PRINCESS!"]));
  achievements_shop = achievements_shop.concat(genShopAchievements(10, ["Nightmare Night", "Mother's Day", "Farmer's Day", "Rainbow Dash Is Awesome Day", "National Butt Day"]));
  achievements_shop = achievements_shop.concat(genShopAchievements(11, ["Loyalty", "Honesty", "Laughter", "Generosity", "Kindness"]));

  achievementCount += 7; // for our special ones at the end
  document.getElementById('achievements_total').innerHTML = achievementCount.toFixed(0);
  
  var score = document.getElementById("scorenum");
  var store = document.getElementById("store");
  var stat_cursmiles = document.getElementById('stat_cursmiles');
  var stat_totalsmiles = document.getElementById('stat_totalsmiles');
  var stat_SPS = document.getElementById('stat_SPS');
  var stat_clicks = document.getElementById('stat_clicks');
  var stat_SPC = document.getElementById('stat_SPC');
  var stat_buildings = document.getElementById('stat_buildings');
  var stat_time = document.getElementById('stat_time');
  var stat_muffins = document.getElementById('stat_muffins');
  var stat_achievementmuffins = document.getElementById('stat_achievementmuffins');
  var achievements_owned = document.getElementById('achievements_owned');
  var upgrades_owned = document.getElementById('upgrades_owned');
  var ponywrapper = document.getElementById('ponywrapper');
  var smilethumb = '<img src="./pinkiehappy.png" alt="Smiles: " title="Smiles" />';
  var canvas = document.getElementById("canvas");
  var ctx = canvas.getContext("2d");
  var canvaslines = document.getElementById("canvaslines");
  var ctxlines = canvaslines.getContext("2d");

  function dynFontSize(str) {
    var size=80;
    if(str.length < 21) {
      size=100;
    } else if(str.length < 31) {
      size=90;
    }
    return '<span style="font-size:'+size+'%;">'+str+'</span>';
  }
  function updateUpgradesAchievements() {
    achievements_owned.innerHTML = Game.achievementcount.toFixed(0);
    upgrades_owned.innerHTML = Game.upgrades.length.toFixed(0);
    var html = '';
    
    var count = 0;
    for (var prop in achievementList) {
        if (achievementList.hasOwnProperty(prop)) {
          html += '<div class="achievement '+(Game.achievements[prop]===undefined?'hidden':'')+'"><div class="menutooltip" style="left: '+(-2-((count%5)*54))+'px;"><strong>'+dynFontSize(achievementList[prop].name)+'</strong><i>[achievement]</i><hr/><p>'+achievementList[prop].desc+'</p></div></div>';
        }
        count++;
    }    
    document.getElementById('achievements').innerHTML = html;
    
    html = '';
    for(var i = 0; i < Game.upgrades.length; ++i) {
      html += '<div class="achievement"><div class="menutooltip" style="left: '+(-2-((i%5)*54))+'px;"><strong>'+dynFontSize(upgradeList[Game.upgrades[i]].name)+'</strong><i>[upgrade]</i><hr/><p>'+upgradeList[Game.upgrades[i]].desc+'</p></div></div>';
    }
    
    document.getElementById('upgradelist').innerHTML = html;
    UpdateMuffins();
  }
  
  function ResizeCanvas() {
    canvas.width  = document.getElementById('ponybg').offsetWidth;
    canvas.height = document.getElementById('ponyboard').offsetHeight;
  }
  
  // Generate store HTML
  var storehtml = '';
  for(var i = 0; i < Store.length; ++i) {
    var ponyreq = (i!=1)?'':'<span id="ponycost">(2 PONIES)</span>';
    storehtml += '<li class="disable" id="buy' + i + '" onclick="if(this.className != \'disable\') { Buy(' + i + ') } else { ShowMouseText(\'Too expensive!\',0,-40); }" oncontextmenu="Sell(' + i + '); return false;">' + Store[i].name.toLowerCase() + '<br/><span class="cost">'+smilethumb+'<span id="cost' + i + '">0</span></span>' + ponyreq + '<span class="count" id="count' + i + '">0</span></li>';
  }
  store.innerHTML += storehtml;
  
  function Click(id) {
      var amount = Math.floor(Game.SPC);
      Earn(amount);
      Game.clicks += 1;
      stat_clicks.innerHTML = PrettyNum(Game.clicks);
      ShowMouseText('+' + PrettyNum(amount), 2, -40);
      CheckAchievements(achievements_clicks);
  }
  function triangular(n) {
    return (n*(n-1))/2; // number of edges in a complete graph of n nodes
  }
  function inv_triangular(n) {
    return 0.5*(Math.sqrt(8*n + 1) + 1); // Returns the triangular number that would produce this many edges
  }
  function fbnext(x) {
    return x + 1 + (x>>1) + (x>>3) - (x>>7) + (x>>10) - (x>>13);
  }
  
  // The game's difficulty is modelled using a series of curves defined by these values
  function fn_ratio(init,curve) { return function(n) { return init*Math.pow(curve,n); }; }
  var fcurve = 1.3; // Friendship curve
  var fcurve_init = 20;
  var rcurve = 1.1; // cost ratio curve
  var rcurve_init = 30; // Initial cost ratio (for a party)
  var fn_rratio = fn_ratio(rcurve_init,rcurve); // gets the SPS ratio for a store of level n
  
  // The fundamental curve is the cost of friendships. This forms a simple recurrence relation f_n = a*f_n-1, which has a closed-form solution of f_n = f_0*a^n
  var fn_cost1 = fn_ratio(fcurve_init, fcurve);
  
  // The cost of ponies is based on the cost of buying k+1 friendships, where k is the number of edges in a complete graph of n-nodes, which is just a triangular number. So, we take the current number of ponies, find the corresponding triangular number, add one and plug that into the friendship cost function.
  var fn_cost0 = function(n) { return (n<2)?15:fn_cost1(triangular(n)+1); };
  
  function default_cost(i, n) { return Store[i].initcost*Math.pow(Store[i].costcurve,n); };
  function inv_cost(i, cost) { return Math.log(cost/Store[i].initcost)/Math.log(Store[i].costcurve); }
  
  Store[0].fn_SPS = function(P,F,B) { return 0; };
  Store[1].fn_SPS = function(P,F,B) { return 1.0; };
  Store[2].fn_SPS = function(P,F,B) { return P; };
  Store[3].fn_SPS = function(P,F,B) { return F; };
  Store[4].fn_SPS = function(P,F,B) { return (P+F)*4.0; };
  Store[5].fn_SPS = function(P,F,B) { return (P+F+B); };
  Store[6].fn_SPS = function(P,F,B) { return (P*F)*1.5; };
  Store[7].fn_SPS = function(P,F,B) { return (P*(F+B)); };
  Store[8].fn_SPS = function(P,F,B) { return (P*F*(B+1)); };
  Store[9].fn_SPS = function(P,F,B) { return Math.pow(2, P)*F*(B+1); };
  Store[10].fn_SPS = function(P,F,B) { return max_binomial(P*2)*(F+B); };
  Store[11].fn_SPS = function(P,F,B) { return factorial(P)*(F+B); };
  Store[12].fn_SPS = function(P,F,B) { return 0; };
  
  // A store's initial cost is based on the number of friendships you (should) have already bought, or can currently afford, which is then used to calculate how many of everything else you have to generate a SPS and then apply the relevant SPS ratio to derive the appropriate cost
  
  function initSPS(f,r,b) { return Store[r].fn_SPS(Math.floor(inv_triangular(f)),f,b); }
  function initcost(f,r,b) { return initSPS(f,r,b)*fn_rratio(r-2); }
  
  // You are expected to build n instances of a building before the cost of one SPS on the old building becomes equal to to the per SPS cost of the next building up. n itself is defined as a curve on the building level.
  
  var ncurve_init = 6;
  var ncurve = 1.2;
  var fn_nratio = fn_ratio(ncurve_init,ncurve);
  
  function fn_costcurve(f,r,b)
  {  
  // COST_3(F)/SPS_3(F) = COST_2(F)/SPS_2(F)
  // initial cost over initial SPS is always fn_rratio
  // fn_rratio(3-2) = (init*(curve^n))/initSPS(6,2,n)
  // solve this for curve:
  // curve = ((fn_rratio(3-2)*initSPS(6,2,n))/init)^(1/n)
    var n = fn_nratio(r-2);
    return Math.pow((fn_rratio(r-2)*initSPS(f,r,n+b))/Store[r].initcost,2.0/n); // modify 1.0/n to 2.0/n for balancing tweaking
  }
  
  var Fvals = [4,6,10,16,32,42,68,80,90,104,140];
  
  for(var i = 2; i < 12; ++i) {
    var cost = (i<3)?0:default_cost(i-1,fn_nratio(i-3));
    var b = 0;
    for(var j = 2; j < i-1; ++j) {
      b += inv_cost(j, cost);
    }
    Store[i].initcost = initcost(Fvals[i-2],i,b+fn_nratio(i-3));
    Store[i].costcurve = fn_costcurve(Fvals[i-1],i,b);
  }  
  
  Store[0].cost = fn_cost0;
  Store[1].cost = fn_cost1;
  Store[2].cost = function(n) { return default_cost(2, n); };
  Store[3].cost = function(n) { return default_cost(3, n); }; 
  Store[4].cost = function(n) { return default_cost(4, n); }; 
  Store[5].cost = function(n) { return default_cost(5, n); }; 
  Store[6].cost = function(n) { return default_cost(6, n); }; 
  Store[7].cost = function(n) { return default_cost(7, n); }; 
  Store[8].cost = function(n) { return default_cost(8, n); }; 
  Store[9].cost = function(n) { return default_cost(9, n); }; 
  Store[10].cost = function(n) { return default_cost(10, n); }; 
  Store[11].cost = function(n) { return default_cost(11, n); };
  Store[12].cost = function(n) { return 1; };
  
  // Effects of buying a store item
  Store[0].effect = function(obj) { };
  Store[1].effect = function(obj) { };
  Store[2].effect = function(obj) { };
  Store[3].effect = function(obj) { };
  Store[4].effect = function(obj) { };
  Store[5].effect = function(obj) { };
  Store[6].effect = function(obj) { };
  Store[7].effect = function(obj) { };
  Store[8].effect = function(obj) { };
  Store[9].effect = function(obj) { };
  Store[10].effect = function(obj) { };
  Store[11].effect = function(obj) { };
  Store[12].effect = function(obj) {
    Game.upgrades.push(upgradeList.length-1);
  };
  
  function Earn(num) {
    if(num>0) { Game.totalsmiles += num; }
    Game.smiles += num;
    score.innerHTML = Pluralize(Game.smiles, " smile");
    stat_cursmiles.innerHTML = PrettyNum(Game.smiles);
    stat_totalsmiles.innerHTML = PrettyNum(Game.totalsmiles);
    UpdateStore();
    CheckAchievements(achievements_smiles);
  }
  function EarnAchievement(id) {
    if(Game.achievements[id] === undefined) {
      Game.achievements[id] = achievementList[id].muffins;
      Game.achievementcount++;
      ShowNotice(achievementList[id].name, achievementList[id].desc, "achievement");
      Game.muffins += achievementList[id].muffins;
      Game.achievement_muffins += achievementList[id].muffins;
      updateUpgradesAchievements();
      if(Game.achievementcount >= (achievementCount-1)) {
        EarnAchievement(255);
      }
    }
  }
  function CheckAchievements(list) {
    for(var i = 0; i < list.length; ++i) {
      if(achievementList[list[i]].cond()) {
        EarnAchievement(list[i]);
      }
    }
  }
  function UpdateUpgrades() {
    Game.SPC = 1;
    for(var i = 0; i < Store.length; ++i) {
      Store[i].pbonus = 0;
      Store[i].mbonus = 1;
    }
    for(var i = 0; i < Game.upgrades.length; ++i) {
      upgradeList[Game.upgrades[i]].fn();
    }
    stat_SPC.innerHTML = PrettyNum(Game.SPC);
  }
  function UpdateStore() {
    UpdateUpgrades();
    var ponycost = document.getElementById("ponycost");
    ponycost.innerHTML = "(NEEDS " + Math.ceil(inv_triangular(Game.store[1]+1)) + " PONIES)";
    ponycost.style.display = 'none';
    for(var i = 0; i < Store.length; ++i) { 
      var item = Store[i];
      var count = Game.store[i];
      var cost = item.cost(count);
      if(i == 1 && count >= triangular(Game.store[0])) {
        document.getElementById("buy" + i).className = "disable";
        ponycost.style.display = 'inline';
      } else {
        document.getElementById("buy" + i).className = (cost>Game.smiles)?"disable":"";
      }
      document.getElementById("cost" + i).innerHTML = PrettyNum(cost);
      document.getElementById("count" + i).innerHTML = count;
    }
    
    var html = '';
    for(var i = 0; i < upgradeList.length; ++i) {
      html += '<div class="achievement"><div class="menutooltip" style="left: '+(-2-((i%6)*54))+'px;"><strong>'+dynFontSize(upgradeList[i].name)+'</strong><i>[upgrade]</i><hr/><p>'+upgradeList[i].desc+'</p></div></div>';
    }
    document.getElementById('storeupgrades').innerHTML = html;
  }
  function CountBuildings(store) {
    var count = 0;
    for(var i = 2; i < store.length; ++i) {
      count += store[i];
    }
    return count;
  }
  // Seperating this out lets us make predictions on what a purchase will do to your SPS
  function CalcSPS(store, docache) {
    var P = store[0];
    var F = store[1];
    var B = CountBuildings(store);
    var SPS = 0;
    var cache;
    for(var i = 0; i < Store.length; ++i) {
      cache = Store[i].fn_SPS(P,F,B);
      if(docache) { Store[i].SPS_cache = cache; }
      SPS += store[i]*cache;
    }
    return SPS;
  }
  function UpdateSPS() {
    Game.SPS = CalcSPS(Game.store, true);
  
    var s = document.getElementById("SPS");
    if(Game.SPS > 0) {
      s.style.display = "block";
      s.innerHTML = "+" + ((Game.SPS<=999)?Game.SPS.toFixed(1):PrettyNum(Game.SPS)) + " per second";
    } else {
      s.style.display = "none";
    }
    
    stat_SPS.innerHTML = PrettyNum(Game.SPS);
  }
  function displayTime(milliseconds) {
    var seconds = Math.floor(milliseconds/1000)%60;
    var minutes = Math.floor(milliseconds/60000)%60;
    return Math.floor(milliseconds/3600000).toFixed(0) + ':' + (minutes<10?'0':'') +  minutes.toFixed(0) + ':' + (seconds<10?'0':'') + seconds.toFixed(0);
  }
  function drawImage(img, x, y, r) {
    if(r != 0) {
      ctx.translate(img.width/2, img.height/2); 
      ctx.translate(x, y);
      ctx.rotate(r); 
      ctx.drawImage(img,-img.width/2,-img.height/2);
    } else {
      ctx.drawImage(img, x, y);
    }
    ctx.restore();
  }
  
  var lastTime;
  var startTime;
  var lastTick; // Ticks are used for things like updating the total playtime
  function UpdateGame(timestamp) {
    if (!startTime) { 
      startTime = timestamp;
      lastNews = timestamp;
      lastTime = timestamp;
      lastTick = timestamp;
    }
    Game.delta = timestamp - lastTime;
    var hasFocus = !Game.settings.optimizeFocus || document.hasFocus();
    var framelength = (hasFocus?33:500); // 33 is 30 FPS
    if(Game.delta>framelength) { // play at 30 FPS or the text starts flickering
      ProcessSPS(Game.delta);
      lastTime = timestamp;
    }
    if((timestamp - lastNews)>newswait) {
      UpdateNews();
      lastNews = timestamp;
    }
    if((timestamp - lastTick)>500) {
      Game.totalTime += 500;
      stat_time.innerHTML = displayTime(Game.totalTime);
      UpdateOverlay(null, null);
      lastTick = timestamp;
    }
    if(Game.settings.useCanvas && (hasFocus || Game.delta>framelength)) {
      var grd = ctx.createLinearGradient(0,0,0,canvas.height);
      grd.addColorStop(0,"#d8f6ff");
      grd.addColorStop(1,"#1288e2");
      ctx.fillStyle = grd;
      ctx.fillRect(0,0,canvas.width,canvas.height);
          
      var img_rays = document.getElementById('img_rays');
      img_rays.width = 2470;
      img_rays.height = 2460;
      var img_ground = document.getElementById('img_ground');
      img_ground.width = 2051;
      img_ground.height = 560;
      ctx.save(); 
      drawImage(img_rays, canvas.width/2-img_rays.width/2, canvas.height-img_rays.height/2, ((timestamp - startTime)/3000)%(2*Math.PI));
      drawImage(img_ground, canvas.width/2-img_ground.width/2, canvas.height-img_ground.height/2, 0);     
    }
    window.requestAnimationFrame(UpdateGame);
  }
  function UpdateOverlay(item, y) {
    var overlay = document.getElementById("overlay");
    if(y != null && item >= 0) {
      overlay.style.top = y-40 + 'px';
    }
    if(item == null) {
      item = overlay.getAttribute('data-item', item);
    } else if(item == overlay.getAttribute('data-item', item)) {
      return;
    }
    overlay.setAttribute('data-item', item);
    
    if(item < 0) {
      overlay.style.display = 'none';
      return;
    }
    
    var x = Store[item];
    var xcount = Game.store[item];
    var xcost = x.cost(xcount);
    overlay.style.display = 'block';
    var html = '<div class="title"><p>'+x.name+'</p><span>'+smilethumb+PrettyNum(xcost)+'</span>';
    if(xcount > 0) { html += '<div>['+PrettyNum(xcount)+' owned]</div>'; }
    html += '</div><hr/><p>'+x.desc+'</p><hr/><ol>';
    if(x.formula) { html += '<li>'+x.formula+'</li>'; }
    if(x.SPS_cache > 0) { html += '<li>Each '+x.name.toLowerCase()+' generates <b>'+Pluralize(x.SPS_cache, ' smile')+'</b> per second</li>'; }
    if(xcount > 0 && x.SPS_cache > 0) { html += '<li><b>'+PrettyNum(xcount)+'</b> '+x.plural.toLowerCase()+' generating <b>'+Pluralize(xcount*x.SPS_cache, ' smile')+'</b> per second</li>'; }
    var nstore = Game.store.slice();
    nstore[item]+=1;
    var nSPS = CalcSPS(nstore, false);
    
    html += '<li>Buying one '+x.name.toLowerCase()+' will increase your SPS by <b>'+PrettyNum(nSPS - Game.SPS)+'</b><i>You pay <b>'+Pluralize(xcost/(nSPS - Game.SPS), ' smile') + '</b> per +1 SPS</li></ol>';
    
    overlay.innerHTML = html;
  }
  function ProcessSPS(delta) {
    Earn(Game.SPS*(delta/1000.0));
  }
  
  function Buy(id) {
    var n = Game.shiftDown?10:1;
    var numPurchase=0;
    var totalCost=0;
    for(var i = 0; i < n; ++i) {
      var cost = Store[id].cost(Game.store[id]);
      if(Game.smiles >= cost) {
        numPurchase++;
        totalCost+=cost;
        Earn(-1 * cost);
        Game.store[id] += 1;
        Store[id].effect(Store[id]);
      }
    }
    if(n>1) {
      ShowNotice(Store[id].name, "Purchased <b>" + numPurchase + " " + Store[id].plural + "</b> for <b>" + Pluralize(totalCost, " smile") + "</b>");
    }
    
    UpdateStore();
    UpdateSPS();
    UpdateOverlay(null, null);
    OrganizePonies();
    stat_buildings.innerHTML = CountBuildings(Game.store).toFixed(0);
    CheckAchievements(achievements_shop);
  }
  function Sell(id) {
    if(!id) return; // you can't sell ponies you heartless monster
    if(id == 1) { EarnAchievement(205); }
    
    var n = Game.shiftDown?10:1;
    var numSell=0;
    var totalCost=0;
    for(var i = 0; i < n; ++i) {
      if(Game.store[id]>0) {
        Game.store[id] -= 1;
        var cost = 0.5 * Store[id].cost(Game.store[id]);
        Earn(cost);
        numSell++;
        totalCost+=cost;
      }
    }
    if(n>1) {
      ShowNotice(Store[id].name, "Sold <b>" + numSell + " " + Store[id].plural + "</b> for <b>" + Pluralize(totalCost, " smile") + "</b>");
    }
    UpdateStore();
    UpdateSPS();
    UpdateOverlay(null, null);
    OrganizePonies();
    stat_buildings.innerHTML = CountBuildings(Game.store).toFixed(0);
  }
  function distance(x1,y1,x2,y2) {
     return Math.sqrt((x1-x2)*(x1-x2) + (y1-y2)*(y1-y2));
  }
  function GetEdgeLength(r, n) {
    switch(n)
    {
      case 1: return 400;
      case 2: return 350;
      case 3: return 300;
      case 4: return 260;
    }
    var a = (2*Math.PI)/n;
    var tx = Math.cos(a)*r - r;
    var ty = Math.sin(a)*r - 0;
    return Math.pow(ty*ty + tx*tx,0.5*0.95);
  }
  function OrganizePonies() {
    var n = Game.store[0];
    var r=(n>1?260:0);
    var a = (2*Math.PI)/n;
    var th = (n-2)*0.08;
    var html = '';
    var edge = GetEdgeLength(r, n);
    for(var i = 0; i < n; ++i) {
      var pone = ((i<Game.ponyList.length)?Game.ponyList[i]:0);
      html += '<div class="pony" id="pony'+i+'" onclick="Click('+i+');" style="top:'+(Math.sin(a*i + th)*r-(edge/2))+'px;left:'+(Math.cos(a*i + th)*r-(edge/2))+'px;width:'+edge+'px;height:'+edge+'px;background-size: '+edge+'px '+edge+'px;background-image:url(\'./ponies/'+PonyList[pone]+'\');"></div>';
    }
    ponywrapper.innerHTML = html;
    
    var grd = ctxlines.createLinearGradient(0,0,0,canvas.height);
    grd.addColorStop(0,"#d8f6ff");
    grd.addColorStop(1,"#1288e2");
    ctxlines.fillStyle = grd;
    ctxlines.fillRect(0,0,canvas.width,canvas.height);
    
    // Draw friendship lines
    ctxlines.clearRect(0, 0, canvaslines.width, canvaslines.height);
    ctxlines.beginPath();
    ctxlines.lineWidth="3";
    ctxlines.strokeStyle="#333";
    if(n>1) {
      var f = Game.store[1];
      var k = n-1;
      var j = 0;
      for(var i = 0; i < f; ++i) {
          var p1 = j;
          var p2 = j+k;
          var x1 = Math.cos(a*p1 + th)*r + r;
          var y1 = Math.sin(a*p1 + th)*r + r;
          var x2 = Math.cos(a*p2 + th)*r + r;
          var y2 = Math.sin(a*p2 + th)*r + r;
          ctxlines.moveTo(x1,y1);
          ctxlines.lineTo(x2,y2);
          j += 1;
          if((j+k) >= n) { j=0; k-=1; }
      }
    }
    ctxlines.stroke();
  }
  
  var setShiftDown = function(event){
      if(event.keyCode === 16 || event.charCode === 16){
          Game.shiftDown = true;
      }
  };

  var setShiftUp = function(event){
      if(event.keyCode === 16 || event.charCode === 16){
          Game.shiftDown = false;
      }
  };
  function aniEndFunc() {
    this.parentNode.removeChild(this);
  }
  function ShowMouseText(text,x,y) {
      var div = document.createElement('div'); // We have to do this the hard way because innerHTML forces a re-evaluation of all the elements, replaying all the animations
      div.className = 'mousetext';
      div.style.left = (curMouseX+x)+'px';
      div.style.top = (curMouseY+y)+'px';
      div.innerHTML = '<p>'+text+'</p>';
      div.addEventListener('webkitAnimationEnd', aniEndFunc, false);
      div.addEventListener('animationend', aniEndFunc, false);
      document.getElementById('mousetexts').appendChild(div);
      //document.getElementById('mousetexts').innerHTML += '<div class="mousetext" style="left:'+(curMouseX+x)+'px;top:'+(curMouseY+y)+'px"><p>'+text+'</p></div>';
  }
  function ShowNotice(title, desc, flavor) {
    var div = document.createElement('div');
    div.innerHTML = '<strong>'+title+'</strong>'+(flavor!=null?'<i>['+flavor+']</i>':'') + (desc!=null?'<hr/><p>'+desc+'</p>':'');
    div.addEventListener('webkitAnimationEnd', aniEndFunc, false);
    div.addEventListener('animationend', aniEndFunc, false);
    div.addEventListener('click', aniEndFunc, false);
    var elem = document.getElementById('notices');
    elem.insertBefore(div, elem.firstChild);
  }
  
  function ShowMenu(b) {
    var btn = document.getElementById('menubutton');
    var menu = document.getElementById('menu');
    var board = document.getElementById('ponyboard');
    if(b) {
      btn.style.display = 'none';
      menu.style.display = 'block';
      board.style.paddingLeft = '259px';
    } else {
      btn.style.display = 'inline-block';
      menu.style.display = 'none';
      board.style.paddingLeft = '0';
    }
    ResizeCanvas();
  }
  // You would not believe the horrific sequence of events that led to the creation of this function.
  var setMouseMove = function(event){
    var root = document.getElementById('buy0');
    var wrapper = document.getElementById('storewrapper');
    var item = -1;
    if((event.clientX>wrapper.offsetLeft) && (event.clientY>root.offsetTop)) {
      item = Math.floor((event.clientY - root.offsetTop)/root.offsetHeight);
      if(item >= Store.length) { item = -1; }
    }
    curMouseX=event.clientX;
    curMouseY=event.clientY;
    
    UpdateOverlay(item, event.clientY);
    EarnAchievement(1);
  };

  function doOnLoad() {
    document.onmousemove = setMouseMove;
    window.addEventListener? document.addEventListener('keydown', setShiftDown) : document.attachEvent('keydown', setShiftDown);
    window.addEventListener? document.addEventListener('keyup', setShiftUp) : document.attachEvent('keyup', setShiftUp);
    window.onbeforeunload = function (e) {
        if(!Game.settings.closingWarn) { return null; }
        e = e || window.event;
        var text = "You are about to leave Pony Clicker!";
        if (e) { e.returnValue = text; }
        return text;
    };

    InitializeGame();
    ResizeCanvas();
    window.requestAnimationFrame(UpdateGame);
  }
  </script>
</body>
</html>