<!doctype html>
<html>
<head>
  <title>Pony Clicker</title>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge;chrome=1" />
  <meta charset="utf-8" />
  <meta name="description" content="Pony Clicker v0.1 by Cloud Hop" />
  <meta name="copyright" content="Copyright (c)2015 Cloud Hop" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="./ponyclicker.css" media="screen"/>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:700,400' rel='stylesheet' type='text/css'>
</head>
<body >
  <div class="container">
    <div id="ponyboard">
      <div class="bg">
      <img class="rays" src="rays.svg" />
      <img class="rays2" src="rays2.svg" />
      <img class="ground" src="ground.svg" />
      </div>
      <div id="score"><span id="scorenum">0 Smiles</span><div id="SPS">+0.1 per second</div></div>
      <div id="ponywrapper" class="ponies">
      </div>
      </div>
    </div>
  </div>
  <div class="button" id="menubutton" onclick="ShowMenu(true);">Menu &raquo;</div>
  <div id="menu" class="menu">
  <div class="button" onclick="ShowMenu(false);">Menu &laquo;</div>
  <div class="button" onclick="">Save</div>
  <div class="button" onclick="">Export</div>
  <div class="button" onclick="document.getElementById('credits').style.display='block';">Credits</div>
    <hr/>
    <input type="checkbox" id="EnableEffects" />
    <label for="EnableEffects" >Enable canvas effects</label>
    <br/><input type="checkbox" id="EnableFocus" />
    <label for="EnableFocus" >Lower FPS when not focused</label>
    <br/><input type="checkbox" id="EnableWarn" />
    <label for="EnableWarn" >Warn when closing window</label>
      <hr/>
      Smiles Available: <span id="stat_cursmiles">0</span>
      <br/>Total Smiles: <span id="stat_totalsmiles">0</span>
      <br/>Smiles Per Second: <span id="stat_SPS">0</span>
      <br/>Pony Clicks: <span id="stat_clicks">0</span>
      <br/>Smiles Per Click: <span id="stat_SPC">0</span>
      <br/>Buildings Owned: <span id="stat_buildings">0</span>
      <br/>Time Played: <span id="stat_time">0</span>
      <hr/>
      Upgrades Owned: <span id="upgrades_owned"></span>/<span id="upgrades_total"></span>
      
      <hr/>
      Achievements: <span id="achievements_owned"></span>/<span id="achievements_total"></span>
      <hr/>
      <span style="font-size:70%"><a href="https://www.youtube.com/watch?v=otAFRGL4yX4">The smile song is mandatory while playing this.</a></span>
  </div>
  <ol class="store" id="store">
    <div class="title">Sugarcube Corner</div>
    <ol class="upgrades">
    
    </ol>
  </ol>
  
  <div id="overlay" data-item="2">
    <span><p>Party</p><span>8 smiles</span><div>[8 owned]</div></span>
    <hr/>
    <p>Throw a party for all of your friends!</p>
    <hr/>
    <ol>
      <li>Generates one smile per friendship.
        <i>SPS = F</i>
      </li>
      <li>Each party generates <b>2738 smiles</b> per second</li>
      <li><b>28</b> parties generating <b>273848 smiles</b> per second</li>
      <li>Buying one party will increase your SPS by <b>27.3</b></li>
    </ol>
  </div>
  
    <div id="credits" class="modal" style="width: 450px;height: 400px;display:none;">
      <div class="button" style="position:absolute; right:0; top:0" onclick="document.getElementById('credits').style.display='none';">[x]</div>
      <b>Pony Clicker v0.1 <i>by</i> Cloud Hop</b>
      <hr/>
      <p><a href="http://www.fimfiction.net/user/Cloud%20Hop"><img style="float:left;" src="./Cloudhop_goggles.png" alt="Cloud Hop Avatar" title="Look at those cute little goggles! ^.^" /></a> Cloud Hop is an adorable pegasus who works at the weather factory. He's also an <a href="http://blackhole12.blogspot.com/">applied mathematician</a> who makes <a href="https://github.com/blackhole12">games</a> and <a href="https://erikmcclure.bandcamp.com/album/aurora-theory">music</a>. Sometimes he puts them on the internet, to the dismay of everypony else.
        <ul><li><a href="http://www.fimfiction.net/user/Cloud%20Hop">Fimfiction</a></li>
        <li><a href="http://blackhole12.newgrounds.com">Newgrounds</a></li>
        <li><a href="https://soundcloud.com/blackhole12">Soundcloud</a></li>
        <li><a href="http://blackhole12.blogspot.com/">Blogger</a></li>
        <li><a href="https://www.youtube.com/channel/UCWC8FC5JryUP7I1oN1twBeQ">Youtube</a></li>
        <li><a href="https://twitter.com/blackhole0173">Twitter</a></li>
        </ul>
        </p>
        <p>
          Pinkie Pie vector originally created by <a href="http://blackhole12.deviantart.com/art/Pinkie-Pie-PARTY-TIME-274526114">Takua770</a>
          <br/>Pinkie Pie face taken from Fimfiction emoticons.
          <br/><strong>Playtesters:</strong> Ambris, Fyrestorm, Zaron
        </p>
        <hr/>
        <div class="footer"><a href="#">Fork this project on Github</a></div>
    </div>
  <script type="text/javascript">
  var Game = { store:[],
    upgrades:[], // list of upgrade IDs that are owned.
    smiles:0,
    totalsmiles:0,
    SPC:1,
    SPS:0,
    ponies:[[]], //adjacency list
    buildings:0, // All non-pony, non-friend objects
    shiftDown:false,
    startTime:0,
    clicks:0,
    achievements:[]
  };
  Game.store = [
    {cost:15,count:1,pbonus:0,mbonus:1,name:"Pony", plural: "ponies", desc: "This is a pony. Ponies need friendships to generate smiles."}, 
    {cost:20,count:0,pbonus:0,mbonus:1,name:"Friend", plural: "friends", desc: "A friendship between two ponies. You can't buy a friendship if everypony is friends with everypony else!", formula: "Each friendship generates 0.5 smiles per second"}, 
    {cost:100,count:0,pbonus:0,mbonus:1,name:"Recital", plural: "recitals", desc: "A small recital for everypony you know.", formula: "Generates one smile per pony.<i>SPS = P</i>"}, // P
    {cost:1200,count:0,pbonus:0,mbonus:1,name:"Party", plural: "parties", desc: "Throw a party for all your friends!", formula: "Generates one smile per friendship.<i>SPS = F</i>"}, // F
    {cost:3000,count:0,pbonus:0,mbonus:1,name:"Parade", plural: "parades", desc: "Throw a big parade for everypony and all their friends!"}, // P+F
    {cost:10000,count:0,pbonus:0,mbonus:1,name:"Concert", plural: "concerts", desc: "Throw a concert for the whole town!"}, // P+F+B
    {cost:150000,count:0,pbonus:0,mbonus:1,name:"Festival", plural: "festivals", desc: "Celebrate a festival for a whole weekend!"}, // P*F
    {cost:25000000,count:0,pbonus:0,mbonus:1,name:"Rave", plural: "raves", desc: "Throw a gigantic rave party in Canterlot!"}, // P*(F+B)
    {cost:987654321,count:0,pbonus:0,mbonus:1,name:"Grand Galloping Gala", plural: "grand galloping galas", desc: "Celebrate the Grand Galloping Gala with ponies from all over Equestria!"}, //P*F*B
    {cost:10000000000,count:0,pbonus:0,mbonus:1,name:"Coronation", plural: "coronations", desc: "Make some random pony a princess so you have an excuse to party all night!"}, //2^P
    {cost:9999999999999,count:0,pbonus:0,mbonus:1,name:"National Holiday", plural: "national holidays", desc: "Declare a national holiday so everypony in equestria can party with you instead of doing anything useful!"}, //2^P*F
    {cost:99999999999999999,count:0,pbonus:0,mbonus:1,name:"Elements Of Harmony", plural: "Elements of Harmony", desc: "Use a giant rainbow friendship beam to solve all your problems!"}, //2^P*(F+B)
    {cost:1,count:1,name:"DEBUGMOUSE", plural:"DEBUGMOUSES", desc: "DEBUG DO NOT USE"}
  ];
  function basic_upgrade(item, p, m) { Game.store[item].mbonus *= (1.0+m); Game.store[item].pbonus *= (1.0+m); Game.store[item].pbonus += p; }
  function global_upgrade(p, m) { for(var i = 0; i < Game.store.length; ++i) basic_upgrade(i, p, m); }
  function gen_upgradetype1(item, pSPS, mSPS) { return function() { var c = Game.store[item].count; basic_upgrade(item, pSPS*c, mSPS*c); } }
  function factorial(n) { var r = n; while(--n > 1) { r = r*n; } return r; }
  function max_binomial(n) { var n2=Math.floor(n/2); var r = n; while(--n > n2) { r = r*n; } return Math.floor(r/factorial(n2)); }
  
  var number_names = [
  "million",
  "billion",
  "trillion",
  "quadrillion",
  "quintillion",
  "sextillion",
  "septillion",
  "octillion",
  "nonillion",
  "decillion",
  "undecillion",
  "duodecillion",
  "tredecillion",
  "quattuordecillion", // This name is so long it breaks formatting in places :C
  "quindecillion",
  "sexdecillion",
  "septendecillion",
  "octodecillion",
  "novendecillion",
  "vigintillion",
  "centillion"];
  
  function PrettyNum(x) {
    var d = Math.floor(Math.log10(x));
    if(d<6) return x.toFixed(0);
    x = Math.floor(x/Math.pow(10,d-(d%3)-3));
    var n = Math.floor((d-3)/3) - 1;
    if(n >= number_names.length) return "Infinity";
    return (x/1000) + " " + number_names[n];
  }
  function Pluralize(n, s) { return PrettyNum(n) + s + ((n==1)?'':'s'); }
  
  var upgradeList = [ {cost:0, name:"UNDEFINED", desc:"ERROR", fn:null},
    {cost:5000, name:"Friendship Is Magic", desc: "Friendships generate +1 SPS for every other friendship.", fn:gen_upgradetype1(1, 1, 0) },
    {cost:50000, name:"Friendship Is Magic", desc: "Friendships generate +10 SPS for every other friendship.", fn:gen_upgradetype1(1, 10, 0) },
    {cost:50000, name:"Upgrade 3", desc: "Parties generate +1 SPS for every other party.", fn:gen_upgradetype1(2, 1, 0) },
    {cost:0, name:"DEBUGMOUSE", desc: "DEBUG ONLY", fn:function(){Game.SPC*=2;}}
  ];
  for(var i = 0; i < upgradeList.length; ++i) {
    upgradeList[i].id = i;
  }
  document.getElementById('upgrades_total').innerHTML = (upgradeList.length-1).toFixed(0); //-1 for the error one at 0
  
  var achievementList = [ {name: "ERROR", desc: "Congratulations, you broke the game!"},
    {name:"Participation Award", desc: "You moved the mouse!"},
    {name:"Hi there!", desc: "Click a pony <i>once</i>." },
    {name:"That tickles!", desc: "Click a pony <i>10</i> times." },
    {name:"Tickle War", desc: "Click a pony <i>100</i> times." },  
    {name:"Tickle War II: The Retickling", desc: "Click a pony <i>"+PrettyNum(1000)+"</i> times." },  
    {name:"This Can't Be Healthy", desc: "Click a pony <i>"+PrettyNum(10000)+"</i> times." },  
    {name:"Carpal Tunnel Syndrome", desc: "Click a pony <i>"+PrettyNum(100000)+"</i> times." },
    {name:"Wrist In Pieces", desc: "Click a pony <i>"+PrettyNum(1000000)+"</i> times." },  
    {name:"Wrist In Pieces", desc: "Click a pony <i>"+PrettyNum(1000000)+"</i> times." },  
    {name:"Clickception", desc: "Click a pony <i>"+PrettyNum(10000000)+"</i> times." },  
    {name:"Smile!", desc: "Get <i>"+PrettyNum(1)+"</i> smile." },  
    {name:"Laughter", desc: "Get <i>"+PrettyNum(100)+"</i> smiles." },  
    {name:"Joy", desc: "Get <i>"+PrettyNum(10000)+"</i> smiles." },  
    {name:"Bliss", desc: "Get <i>"+PrettyNum(1000000)+"</i> smiles." },  
    {name:"Nirvana", desc: "Get <i>"+PrettyNum(100000000)+"</i> smiles." },  
    {name:"Ecstasy", desc: "Get <i>"+PrettyNum(10000000000)+"</i> smiles." },  
    {name:"Pursuit of Happyness", desc: "Get <i>"+PrettyNum(1000000000000)+"</i> smiles." },  
    {name:"You Can Stop Now", desc: "Get <i>"+PrettyNum(100000000000000)+"</i> smiles." },  
    {name:"Go Read A Book", desc: "Get <i>"+PrettyNum(10000000000000000)+"</i> smiles." },  
    {name:"To Infinity And Beyond", desc: "Get <i>"+PrettyNum(1000000000000000000)+"</i> smiles." },  
    {name:"How?!", desc: "Get <i>"+PrettyNum(100000000000000000000)+"</i> smiles." },  
    {name:"Hobbyist", desc: "Buy <i>"+PrettyNum(1)+"</i> recital." },  
    {name:"Musician", desc: "Buy <i>"+PrettyNum(50)+"</i> recitals." },
    {name:"Cellist", desc: "Buy <i>"+PrettyNum(100)+"</i> recitals." },
    {name:"Multi-instrumentalist", desc: "Buy <i>"+PrettyNum(200)+"</i> recitals." },
    {name:"Conductor", desc: "Buy <i>"+PrettyNum(300)+"</i> recitals." },
 
    {name:"Cautious", desc: "Manually save the game."},
    {name:"Paranoid", desc: "Manually save the game <i>10</i> times."},
    {name:"Goggles!", desc: "Click the image of Cloud Hop on the credits page."},
    {name:"Music Makes Everything Better", desc: "Listen to the smile song."},
    {name:"Completionist", desc: "Get all the achievements."}
  ];
  
  document.getElementById('achievements_total').innerHTML = (achievementList.length-1).toFixed(0); //-1 for the error one at 0
  
  var score = document.getElementById("scorenum");
  var store = document.getElementById("store");
  var stat_cursmiles = document.getElementById('stat_cursmiles');
  var stat_totalsmiles = document.getElementById('stat_totalsmiles');
  var stat_SPS = document.getElementById('stat_SPS');
  var stat_clicks = document.getElementById('stat_clicks');
  var stat_SPC = document.getElementById('stat_SPC');
  var stat_buildings = document.getElementById('stat_buildings');
  var stat_time = document.getElementById('stat_time');
  var achievements_owned = document.getElementById('achievements_owned');
  var upgrades_owned = document.getElementById('upgrades_owned');
  var ponywrapper = document.getElementById('ponywrapper');
  var smilethumb = '<img src="./pinkiehappy.png" alt="Smiles: " title="Smiles" />';
  var framelength = 33; // 33 is 30 FPS
  
  achievements_owned.innerHTML = Game.achievements.length.toFixed(0);
  upgrades_owned.innerHTML = Game.upgrades.length.toFixed(0);
  
  // Generate store HTML
  var storehtml = '';
  for(var i = 0; i < Game.store.length; ++i) {
    var ponyreq = (i!=1)?'':'<span id="ponycost">(2 PONIES)</span>';
    storehtml += '<li class="disable" id="buy' + i + '" onclick="if(this.className != \'disable\') { Buy(' + i + ') }" oncontextmenu="Sell(' + i + '); return false;">' + Game.store[i].name.toLowerCase() + '<br/><span class="cost">'+smilethumb+'<span id="cost' + i + '">0</span></span>' + ponyreq + '<span class="count" id="count' + i + '">0</span></li>';
  }
  store.innerHTML += storehtml;
  
  function Click(id) {
      Earn(Math.floor(Game.SPC));
      Game.clicks += 1;
      stat_clicks.innerHTML = PrettyNum(Game.clicks);
  }
  function triangular(n) {
    return (n*(n-1))/2; // number of edges in a complete graph of n nodes
  }
  function inv_triangular(n) {
    return 0.5*(Math.sqrt(8*n + 1) + 1); // Returns the triangular number that would produce this many edges
  }
  function fbnext(x) {
    return x + 1 + (x>>1) + (x>>3) - (x>>7) + (x>>10) - (x>>13);
  }
  
  // The game's difficulty is modelled using a series of curves defined by these values
  function fn_ratio(init,curve) { return function(n) { return init*Math.pow(curve,n); }; }
  var fcurve = 1.3; // Friendship curve
  var fcurve_init = 20;
  var rcurve = 1.1; // cost ratio curve
  var rcurve_init = 30; // Initial cost ratio (for a party)
  var fn_rratio = fn_ratio(rcurve_init,rcurve); // gets the SPS ratio for a store of level n
  
  // The fundamental curve is the cost of friendships. This forms a simple recurrence relation f_n = a*f_n-1, which has a closed-form solution of f_n = f_0*a^n
  var fn_cost1 = fn_ratio(fcurve_init, fcurve);
  
  // The cost of ponies is based on the cost of buying k+1 friendships, where k is the number of edges in a complete graph of n-nodes, which is just a triangular number. So, we take the current number of ponies, find the corresponding triangular number, add one and plug that into the friendship cost function.
  var fn_cost0 = function(n) { return (n<2)?15:fn_cost1(triangular(n)+1); };
  
  function default_cost(i, n) { return Game.store[i].initcost*Math.pow(Game.store[i].costcurve,n); };
  function inv_cost(i, cost) { return Math.log(cost/Game.store[i].initcost)/Math.log(Game.store[i].costcurve); }
  
  Game.store[0].fn_SPS = function(P,F,B) { return 0; };
  Game.store[1].fn_SPS = function(P,F,B) { return 1.0; };
  Game.store[2].fn_SPS = function(P,F,B) { return P; };
  Game.store[3].fn_SPS = function(P,F,B) { return F; };
  Game.store[4].fn_SPS = function(P,F,B) { return (P+F)*4.0; };
  Game.store[5].fn_SPS = function(P,F,B) { return (P+F+B); };
  Game.store[6].fn_SPS = function(P,F,B) { return (P*F)*1.5; };
  Game.store[7].fn_SPS = function(P,F,B) { return (P*(F+B)); };
  Game.store[8].fn_SPS = function(P,F,B) { return (P*F*(B+1)); };
  Game.store[9].fn_SPS = function(P,F,B) { return Math.pow(2, P)*F*(B+1); };
  Game.store[10].fn_SPS = function(P,F,B) { return max_binomial(P*2)*(F+B); };
  Game.store[11].fn_SPS = function(P,F,B) { return factorial(P)*(F+B); };
  Game.store[12].fn_SPS = function(P,F,B) { return 0; };
  
  // A store's initial cost is based on the number of friendships you (should) have already bought, or can currently afford, which is then used to calculate how many of everything else you have to generate a SPS and then apply the relevant SPS ratio to derive the appropriate cost
  
  function initSPS(f,r,b) { return Game.store[r].fn_SPS(Math.floor(inv_triangular(f)),f,b); }
  function initcost(f,r,b) { return initSPS(f,r,b)*fn_rratio(r-2); }
  
  // You are expected to build n instances of a building before the cost of one SPS on the old building becomes equal to to the per SPS cost of the next building up. n itself is defined as a curve on the building level.
  
  var ncurve_init = 6;
  var ncurve = 1.2;
  var fn_nratio = fn_ratio(ncurve_init,ncurve);
  
  function fn_costcurve(f,r,b)
  {  
  // COST_3(F)/SPS_3(F) = COST_2(F)/SPS_2(F)
  // initial cost over initial SPS is always fn_rratio
  // fn_rratio(3-2) = (init*(curve^n))/initSPS(6,2,n)
  // solve this for curve:
  // curve = ((fn_rratio(3-2)*initSPS(6,2,n))/init)^(1/n)
    var n = fn_nratio(r-2);
    return Math.pow((fn_rratio(r-2)*initSPS(f,r,n+b))/Game.store[r].initcost,2.0/n); // modify 1.0/n to 2.0/n for balancing tweaking
  }
  
  var Fvals = [4,6,10,16,32,42,68,80,90,104,140];
  
  for(var i = 2; i < 12; ++i) {
    var cost = (i<3)?0:default_cost(i-1,fn_nratio(i-3));
    var b = 0;
    for(var j = 2; j < i-1; ++j) {
      b += inv_cost(j, cost);
    }
    Game.store[i].initcost = initcost(Fvals[i-2],i,b+fn_nratio(i-3));
    Game.store[i].costcurve = fn_costcurve(Fvals[i-1],i,b);
  }  
  
  Game.store[0].cost = fn_cost0;
  Game.store[1].cost = fn_cost1;
  Game.store[2].cost = function(n) { return default_cost(2, n); };
  Game.store[3].cost = function(n) { return default_cost(3, n); }; 
  Game.store[4].cost = function(n) { return default_cost(4, n); }; 
  Game.store[5].cost = function(n) { return default_cost(5, n); }; 
  Game.store[6].cost = function(n) { return default_cost(6, n); }; 
  Game.store[7].cost = function(n) { return default_cost(7, n); }; 
  Game.store[8].cost = function(n) { return default_cost(8, n); }; 
  Game.store[9].cost = function(n) { return default_cost(9, n); }; 
  Game.store[10].cost = function(n) { return default_cost(10, n); }; 
  Game.store[11].cost = function(n) { return default_cost(11, n); };
  Game.store[12].cost = function(n) { return 1; };
  
  // Effects of buying a store item
  Game.store[0].effect = function(obj) {
    //obj.cost = fbnext(obj.cost*Math.max(1,obj.count/10));
    Game.ponies.push([]);
  };
  Game.store[1].effect = function(obj) { };
  Game.store[2].effect = function(obj) { Game.buildings += 1; };
  Game.store[3].effect = function(obj) { Game.buildings += 1; };
  Game.store[4].effect = function(obj) { Game.buildings += 1; };
  Game.store[5].effect = function(obj) { Game.buildings += 1; };
  Game.store[6].effect = function(obj) { Game.buildings += 1; };
  Game.store[7].effect = function(obj) { Game.buildings += 1; };
  Game.store[8].effect = function(obj) { Game.buildings += 1; };
  Game.store[9].effect = function(obj) { Game.buildings += 1; };
  Game.store[10].effect = function(obj) { Game.buildings += 1; };
  Game.store[11].effect = function(obj) { Game.buildings += 1; };
  Game.store[12].effect = function(obj) {
    Game.upgrades.push(upgradeList.length-1);
  };
  
  function Earn(num) {
    if(num>0) { Game.totalsmiles += num; }
    Game.smiles += num;
    score.innerHTML = Pluralize(Game.smiles, " smile");
    stat_cursmiles.innerHTML = PrettyNum(Game.smiles);
    stat_totalsmiles.innerHTML = PrettyNum(Game.totalsmiles);
    UpdateStore();
  }
  function UpdateUpgrades() {
    Game.SPC = 1;
    for(var i = 0; i < Game.store.length; ++i) {
      Game.store[i].pbonus = 0;
      Game.store[i].mbonus = 1;
    }
    for(var i = 0; i < Game.upgrades.length; ++i) {
      upgradeList[Game.upgrades[i]].fn();
    }
    stat_SPC.innerHTML = PrettyNum(Game.SPC);
  }
  function UpdateStore() {
    UpdateUpgrades();
    var ponycost = document.getElementById("ponycost");
    ponycost.innerHTML = "(NEEDS " + Math.ceil(inv_triangular(Game.store[1].count+1)) + " PONIES)";
    ponycost.style.display = 'none';
    for(var i = 0; i < Game.store.length; ++i) { 
      var item = Game.store[i];
      var cost = item.cost(item.count);
      if(i == 1 && item.count >= triangular(Game.ponies.length)) {
        document.getElementById("buy" + i).className = "disable";
        ponycost.style.display = 'inline';
      } else {
        document.getElementById("buy" + i).className = (cost>Game.smiles)?"disable":"";
      }
      document.getElementById("cost" + i).innerHTML = PrettyNum(cost);
      document.getElementById("count" + i).innerHTML = item.count;
    }
    UpdateOverlay(null, null);
  }
  function UpdateSPS() {
    var P = Game.ponies.length;
    var F = Game.store[1].count;
    var B = Game.buildings;
    Game.SPS = 0;
    for(var i = 0; i < Game.store.length; ++i) {
      Game.store[i].SPS_cache = Game.store[i].fn_SPS(P,F,B);
      Game.SPS += Game.store[i].count*Game.store[i].SPS_cache;
    }
  
    var s = document.getElementById("SPS");
    if(Game.SPS > 0) {
      s.style.display = "block";
      s.innerHTML = "+" + ((Game.SPS<=999)?Game.SPS.toFixed(1):PrettyNum(Game.SPS)) + " per second";
    } else {
      s.style.display = "none";
    }
    
    stat_SPS.innerHTML = PrettyNum(Game.SPS);
  }
  function displayTime(milliseconds) {
    var seconds = Math.floor(milliseconds/1000)%60;
    var minutes = Math.floor(milliseconds/60000)%60;
    return Math.floor(milliseconds/3600000).toFixed(0) + ':' + (minutes<10?'0':'') +  minutes.toFixed(0) + ':' + (seconds<10?'0':'') + seconds.toFixed(0);
  }
  function UpdateGame(timestamp) {
    if (!Game.startTime) Game.startTime = timestamp;
    if (!Game.time) Game.time = timestamp;
    Game.delta = timestamp - Game.time;
    if(Game.delta>framelength) { // play at 30 FPS or the text starts flickering
      ProcessSPS(Game.delta);
      Game.time = timestamp;
      stat_time.innerHTML = displayTime(Game.time - Game.startTime);
    }
    window.requestAnimationFrame(UpdateGame);
  }
  function UpdateOverlay(item, y) {
    var overlay = document.getElementById("overlay");
    if(y != null) {
      overlay.style.top = y-40 + 'px';
    }
    if(item == null) {
      item = overlay.getAttribute('data-item', item);
    } else if(item == overlay.getAttribute('data-item', item)) {
      return;
    }
    overlay.setAttribute('data-item', item);
    
    if(item < 0) {
      overlay.style.display = 'none';
      return;
    }
    
    var x = Game.store[item];
    overlay.style.display = 'block';
    var html = '<span><p>'+x.name+'</p><span>'+smilethumb+PrettyNum(x.cost(x.count))+'</span>';
    if(x.count > 0) { html += '<div>['+PrettyNum(x.count)+' owned]</div>'; }
    html += '</span><hr/><p>'+x.desc+'</p><hr/><ol>';
    if(x.formula) { html += '<li>'+x.formula+'</li>'; }
    if(x.SPS_cache > 0) { html += '<li>Each '+x.name.toLowerCase()+' generates <b>'+Pluralize(x.SPS_cache, ' smile')+'</b> per second</li>'; }
    if(x.count > 0 && x.SPS_cache > 0) { html += '<li><b>'+PrettyNum(x.count)+'</b> '+x.plural.toLowerCase()+' generating <b>'+Pluralize(x.count*x.SPS_cache, ' smile')+'</b> per second</li>'; }
    html += '<li>Buying one '+x.name.toLowerCase()+' will increase your SPS by <b>'+PrettyNum(27.3)+'</b><i>You pay <b>'+Pluralize(6.2, ' smile') + '</b> per +1 SPS</li></ol>';
    
    overlay.innerHTML = html;
  }
  
  function ProcessSPS(delta) {
    Earn(Game.SPS*(delta/1000.0));
  }
  
  function Buy(id) {
    var n = Game.shiftDown?10:1;
    for(var i = 0; i < n; ++i) {
      var cost = Game.store[id].cost(Game.store[id].count);
      if(Game.smiles >= cost) {
        Earn(-1 * cost);
        Game.store[id].count += 1;
        Game.store[id].effect(Game.store[id]);
      }
    }
    UpdateStore();
    UpdateSPS();
    OrganizePonies();
    stat_buildings.innerHTML = Game.buildings.toFixed(0);
  }
  function Sell(id) {
    if(!id) return; // you can't sell ponies you heartless monster
    var n = Game.shiftDown?10:1;
    for(var i = 0; i < n; ++i) {
      if(Game.store[id].count>0) {
        Game.store[id].count -= 1;
        Game.store[id].effect(Game.store[id]);
        Earn(0.5 * Game.store[id].cost(Game.store[id].count));
      }
    }
    UpdateStore();
    UpdateSPS();
    OrganizePonies();
    stat_buildings.innerHTML = Game.buildings.toFixed(0);
  }
  Game.smiles = 9999999999999999999999999999;
  function distance(x1,y1,x2,y2) {
     return Math.sqrt((x1-x2)*(x1-x2) + (y1-y2)*(y1-y2));
  }
  function GetEdgeLength(r, n) {
    switch(n)
    {
      case 1: return 400;
      case 2: return 350;
      case 3: return 300;
      case 4: return 260;
    }
    var a = (2*Math.PI)/n;
    var tx = Math.cos(a)*r - r;
    var ty = Math.sin(a)*r - 0;
    return Math.pow(ty*ty + tx*tx,0.5*0.95);
  }
  function OrganizePonies() {
    var n = Game.ponies.length;
    var r=(n>1?260:0);
    var html = '';
    var a = (2*Math.PI)/n;
    var th = (n-2)*0.08;
    var edge = GetEdgeLength(r, n);
    for(var i = 0; i < n; ++i) {
      html += '<div class="pony" id="pony'+i+'" onclick="Click('+i+');" style="top:'+(Math.sin(a*i + th)*r-(edge/2))+'px;left:'+(Math.cos(a*i + th)*r-(edge/2))+'px;width:'+edge+'px;height:'+edge+'px;background-size: '+edge+'px '+edge+'px;"></div>';
    }
    if(n>1) {
      var f = Game.store[1].count;
      var k = n-1;
      var j = 0;
      for(var i = 0; i < f; ++i) {
          var p1 = j;
          var p2 = j+k;
          var y1 = Math.sin(a*p1 + th)*r;
          var x1 = Math.cos(a*p1 + th)*r;
          var x2 = Math.cos(a*p2 + th)*r;
          var y2 = Math.sin(a*p2 + th)*r;
          var rot = Math.atan2(y2-y1,x2-x1);
          var d= distance(x1,y1,x2,y2);
        html += '<div class="connect" style="top:'+((y1+y2)/2)+'px;left:'+((x1+x2)/2-(d/2))+'px;width:'+d+'px;height:'+1+'px;-webkit-transform: rotate('+rot+'rad);"></div>';
          j += 1;
          if((j+k) >= n) { j=0; k-=1; }
      }
    }
    ponywrapper.innerHTML = html;
  }
  
  var setShiftDown = function(event){
      if(event.keyCode === 16 || event.charCode === 16){
          Game.shiftDown = true;
      }
  };

  var setShiftUp = function(event){
      if(event.keyCode === 16 || event.charCode === 16){
          Game.shiftDown = false;
      }
  };
  
  function ShowMenu(b) {
    var btn = document.getElementById('menubutton');
    var menu = document.getElementById('menu');
    var board = document.getElementById('ponyboard');
    if(b) {
      btn.style.display = 'none';
      menu.style.display = 'block';
      board.style.paddingLeft = '259px';
    } else {
      btn.style.display = 'inline-block';
      menu.style.display = 'none';
      board.style.paddingLeft = '0';
    }
  }
  // You would not believe the horrific sequence of events that led to the creation of this function.
  var setMouseMove = function(event){
    var store = document.getElementById('store');
    var root = document.getElementById('buy0');
    var item = -1;
    if((event.clientX>store.offsetLeft) && (event.clientY>root.offsetTop)) {
      item = Math.floor((event.clientY - root.offsetTop)/root.offsetHeight);
      if(item >= Game.store.length) { item = -1; }
    }
    
    UpdateOverlay(item, event.clientY);
  };
  document.onmousemove = setMouseMove;
  window.addEventListener? document.addEventListener('keydown', setShiftDown) : document.attachEvent('keydown', setShiftDown);
  window.addEventListener? document.addEventListener('keyup', setShiftUp) : document.attachEvent('keyup', setShiftUp);
  
  Earn(0);
  UpdateSPS();
  OrganizePonies();
  window.requestAnimationFrame(UpdateGame);
  // +1% SPS per digit of SPS
  // +1% SPS per other building of same type
  </script>
</body>
</html>